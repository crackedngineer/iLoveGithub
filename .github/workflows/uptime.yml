name: Uptime Monitor

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  BASE_URL: "https://ilovegithub.vercel.app"

jobs:
  uptime:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check endpoints
        id: check
        run: |
          READYZ=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.BASE_URL }}/api/readyz?force_check=true)
          HEALTH=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.BASE_URL }}/api/health)

          TS=$(date -u +"%Y-%m-%d %H:%M UTC")

          STATUS="UP"
          COLOR="green"

          if [[ "$READYZ" != "200" || "$HEALTH" != "200" ]]; then
            STATUS="DOWN"
            COLOR="red"
          fi

          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "ts=$TS" >> $GITHUB_OUTPUT

        # -----------------------------
      # 2. Create EMPTY orphan branch
      # -----------------------------
      - name: Create clean status branch
        run: |
          git checkout --orphan status
          git rm -rf . || true
          mkdir -p status

      - name: Generate status.json
        run: |
          cat > status/status.json <<EOF
          {
            "status": "${{ steps.check.outputs.status }}",
            "readyz": "${READYZ}",
            "health": "${HEALTH}",
            "checked_at": "${{ steps.check.outputs.ts }}"
          }
          EOF

      - name: Generate shields.json
        run: |
          COLOR="brightgreen"
          MESSAGE="${{ steps.check.outputs.status }}"

          if [ "$MESSAGE" != "UP" ]; then
            COLOR="red"
          fi

          cat > status/shields.json <<EOF
          {
            "schemaVersion": 1,
            "label": "status",
            "message": "$MESSAGE",
            "color": "$COLOR"
          }
          EOF

      - name: Generate STATUS.md
        run: |
          cat > status/STATUS.md <<EOF
          # ðŸ©º Service Status

          **Current Status:** \`${{ steps.check.outputs.status }}\`  
          **Last Checked:** ${{ steps.check.outputs.ts }}

          ## Endpoints
          | Endpoint | Status |
          |---------|--------|
          | /readyz | ${READYZ} |
          | /health | ${HEALTH} |

          ---
          _Updated automatically every 10 minutes via GitHub Actions._
          EOF

      - name: Commit changes to status branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add status/
          git commit -m "chore(status): update uptime (${{
            steps.check.outputs.status
          }})" || exit 0
          git push origin status --force
